<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学术论文搜索器</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1600px; margin: 20px auto; padding: 0 20px; background-color: #f8f9fa; }
        h1, h2 { color: #0056b3; }
        .container { display: flex; gap: 30px; }
        .form-section { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 24%; flex-shrink: 0; }
        /* 新增样式，用于在禁用时让表单变灰且不可点击 */
        fieldset:disabled { opacity: 0.5; pointer-events: none; }
        .results-section { width: 76%; }
        form { display: flex; flex-direction: column; gap: 15px; }
        label { font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #results-table, #arxiv-results-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        #results-table th, #results-table td,
        #arxiv-results-table th, #arxiv-results-table td { border: 1px solid #ddd; padding: 10px; text-align: left; word-wrap: break-word; }
        #results-table th, #arxiv-results-table th { background-color: #e9ecef; }
        #results-table tr:nth-child(even),
        #arxiv-results-table tr:nth-child(even) { background-color: #f8f9fa; }
        #loading { display: none; text-align: center; padding: 20px; font-size: 18px; color: #0056b3; }
        .error { color: #dc3545; }
        #worksheet-tabs button { background-color: #e9ecef; border: 1px solid #ccc; padding: 8px 12px; cursor: pointer; margin-right: 5px; border-radius: 4px 4px 0 0; }
        #worksheet-tabs button.active { background-color: #007bff; color: white; border-color: #007bff; }
        .tab-button { font-size: 18px; padding: 10px 15px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background: none; color: #555; }
        .tab-button.active { border-color: #ccc; border-bottom: 1px solid white; background-color: white; border-radius: 4px 4px 0 0; position: relative; top: 1px; color: #0056b3; font-weight: bold; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .direction-group { border: 1px solid #e0e0e0; padding: 15px; border-radius: 5px; margin-bottom: 15px; position: relative; }
        .direction-group h4 { margin-top: 0; color: #333; }
        .remove-direction-btn { position: absolute; top: 10px; right: 10px; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; line-height: 24px; text-align: center; cursor: pointer; }
        #add-direction-btn { background-color: #28a745; margin-top: 10px; }
    </style>
</head>
<body>
    <div style="border-bottom: 1px solid #ccc; margin-bottom: -1px;">
        <button class="tab-button active" data-tab="semantic-panel">Semantic Scholar 搜索</button>
        <button class="tab-button" data-tab="arxiv-panel">arXiv 时间窗口搜索</button>
    </div>

    <div id="semantic-panel" class="tab-panel active">
        <div class="container">
            <div class="form-section">
                <h2>搜索条件</h2>
                <form id="search-form">
                    <fieldset id="search-fieldset">
                        <div>
                            <label for="query-keywords">查询关键词<br><small>(每行一组, 组内用英文逗号隔开)</small></label>
                            <textarea id="query-keywords" name="query_keywords" placeholder="例如：&#10;LLM, Quantization&#10;Large Language Model, Quantization" required></textarea>
                        </div>
                        
                        <div>
                            <label for="abstract-keywords">摘要必须包含的关键词<br><small>(每行一组, 组内用英文逗号隔开)</small></label>
                            <textarea id="abstract-keywords" name="abstract_keywords" placeholder="例如：&#10;LLM, Quantization&#10;In-Context Learning"></textarea>
                        </div>

                        <div>
                            <label for="year">最低年份</label>
                            <input type="number" id="year" name="year" placeholder="例如: 2023" value="2023">
                        </div>

                        <div id="venues-container">
                            <label for="venues">会议/期刊 (可多选)</label>
                            <select id="venues" name="venues" multiple size="8" style="width: 100%;"></select>
                        </div>
                        
                        <div id="arxiv-citations-container" style="display: none;">
                            <label for="min-arxiv-citations">arXiv 最低引用数 (默认 15)</label>
                            <input type="number" id="min-arxiv-citations" name="min_arxiv_citations" placeholder="例如: 15">
                        </div>

                        <div>
                            <label for="limit">最大篇数</label>
                            <input type="number" id="limit" name="limit" value="100">
                        </div>

                        <div>
                            <label for="title_exclude_keywords">排除标题包含的词 (每行一个)</label>
                            <textarea id="title_exclude_keywords" name="title_exclude_keywords" placeholder="例如：&#10;review&#10;survey"></textarea>
                        </div>
                    </fieldset>
                    
                    <button type="submit" id="submit-btn">搜索</button>
                    <button type="button" id="cancel-btn" style="display: none; background-color: #6c757d;">取消</button>
                </form>
            </div>
            <div class="results-section">
                <h2>搜索结果 <span id="search-summary" style="font-weight: normal; font-size: 0.8em; color: #555;"></span></h2>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div id="worksheet-tabs"></div>
                    <button id="export-btn" style="display: none; padding: 6px 12px; font-size: 14px; margin-left: auto;">导出为 Excel</button>
                </div>
                <div id="loading">正在搜索中，请稍候...</div>
                <div id="error-message" class="error"></div>
                <table id="results-table" style="display:none;">
                    <thead>
                        <tr>
                            <th style="width: 9%;">会议/期刊</th>
                            <th style="width: 5%;">年份</th>
                            <th style="width: 28%;">标题</th>
                            <th style="width: 12%;">匹配关键词</th>
                            <th style="width: 31%;">作者</th>
                            <th style="width: 8%;">引用</th>
                            <th style="width: 7%;">链接</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="arxiv-panel" class="tab-panel">
        <div class="container">
            <div class="form-section">
                <h2>搜索条件</h2>
                <form id="arxiv-search-form">
                    <fieldset id="arxiv-search-fieldset">
                        <div id="arxiv-directions-container">
                            <!-- 动态搜索方向将在这里插入 -->
                        </div>
                        <button type="button" id="add-direction-btn">+ 添加搜索方向</button>
                        
                        <hr style="margin: 20px 0;">

                        <h4>通用设置</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label for="arxiv-days">搜索天数</label>
                                <input type="number" id="arxiv-days" name="days" value="7">
                            </div>
                            <div>
                                <label for="arxiv-limit">最大篇数</label>
                                <input type="number" id="arxiv-limit" name="limit" value="100">
                            </div>
                            <div>
                                <label for="arxiv-min-authors">最少作者</label>
                                <input type="number" id="arxiv-min-authors" name="min_authors" value="1">
                            </div>
                        </div>
                    </fieldset>
                    <button type="submit" id="arxiv-submit-btn">搜索</button>
                    <button type="button" id="arxiv-cancel-btn" style="display: none; background-color: #6c757d;">取消</button>
                </form>
            </div>
            <div class="results-section">
                <h2>搜索结果 <span id="arxiv-search-summary" style="font-weight: normal; font-size: 0.8em; color: #555;"></span></h2>
                 <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div id="arxiv-worksheet-tabs"></div>
                    <button id="arxiv-export-btn" style="display: none; padding: 6px 12px; font-size: 14px; margin-left: auto;">导出为 Excel</button>
                </div>
                <div id="arxiv-loading" style="display: none;">正在搜索中，请稍候...</div>
                <div id="arxiv-error-message" class="error"></div>
                <table id="arxiv-results-table" style="display:none;">
                    <thead>
                        <tr>
                            <th style="width: 10%;">更新日期</th>
                            <th style="width: 10%;">发表日期</th>
                            <th style="width: 40%;">标题</th>
                            <th style="width: 10%;">匹配关键词</th>
                            <th style="width: 25%;">作者</th>
                            <th style="width: 5%;">链接</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 面板切换逻辑 ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabPanels.forEach(panel => {
                        if (panel.id === button.dataset.tab) {
                            panel.classList.add('active');
                        } else {
                            panel.classList.remove('active');
                        }
                    });
                });
            });

            // --- Semantic Scholar 面板逻辑 ---
            let currentSearchController = null; 
            let searchStartTime;
            let currentResults = {}; 
            let originalTitle = document.title;
            let flashInterval = null;

            const venuesSelect = document.getElementById('venues');
            const searchForm = document.getElementById('search-form');
            const searchFieldset = document.getElementById('search-fieldset'); 
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const loadingDiv = document.getElementById('loading');
            const resultsTable = document.getElementById('results-table');
            const resultsBody = resultsTable.querySelector('tbody');
            const errorMessageDiv = document.getElementById('error-message');
            const searchSummarySpan = document.getElementById('search-summary');
            const worksheetTabs = document.getElementById('worksheet-tabs');
            const exportBtn = document.getElementById('export-btn');
            const venuesContainer = document.getElementById('venues-container');
            const arxivCitationsContainer = document.getElementById('arxiv-citations-container');

            // 当会议/期刊选择变化时，检查是否选择了 arXiv
            venuesSelect.addEventListener('change', function() {
                const selectedOptions = Array.from(venuesSelect.selectedOptions).map(opt => opt.value);
                if (selectedOptions.includes('arXiv')) {
                    arxivCitationsContainer.style.display = 'block';
                } else {
                    arxivCitationsContainer.style.display = 'none';
                }
            });

            // 实现更智能的点击取消/选择和拖动选择功能
            let mouseDownTime = 0;
            venuesSelect.addEventListener('mousedown', function(event) {
                if (event.target.tagName === 'OPTION') {
                    mouseDownTime = new Date().getTime();
                }
            });

            venuesSelect.addEventListener('mouseup', function(event) {
                if (event.target.tagName === 'OPTION') {
                    const mouseUpTime = new Date().getTime();
                    // 如果按下和松开的时间间隔很短，则视为一次“单击”
                    if (mouseUpTime - mouseDownTime < 50) {
                        event.preventDefault(); // 阻止默认的单击行为
                        const option = event.target;
                        option.selected = !option.selected;
                        
                        // 手动触发 change 事件
                        const changeEvent = new Event('change', { bubbles: true });
                        venuesSelect.dispatchEvent(changeEvent);
                    }
                    // 如果时间间隔较长，则不执行任何操作，让浏览器处理拖动选择
                }
            });

            // 当用户切回此标签页时，停止闪烁
            window.addEventListener('focus', stopFlashing);

            fetch('/api/venues')
                .then(response => response.json())
                .then(data => {
                    venuesSelect.innerHTML = ''; // 清空现有选项
                    data.forEach(group => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = group.category;
                        
                        group.venues.forEach(venue => {
                            const option = document.createElement('option');
                            option.value = venue.key;
                            option.textContent = venue.name;
                            optgroup.appendChild(option);
                        });
                        
                        venuesSelect.appendChild(optgroup);
                    });
                })
                .catch(error => console.error('加载会议列表失败:', error));

            function startFlashing(message) {
                if (flashInterval) return; // 如果已经在闪烁，则不执行任何操作
                let flashing = false;
                flashInterval = setInterval(() => {
                    document.title = flashing ? originalTitle : message;
                    flashing = !flashing;
                }, 800); // 每800毫秒切换一次
            }

            function stopFlashing() {
                if (flashInterval) {
                    clearInterval(flashInterval);
                    flashInterval = null;
                    document.title = originalTitle;
                }
            }

            function resetFormUI() {
                loadingDiv.style.display = 'none';
                searchFieldset.disabled = false;
                submitBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                currentSearchController = null;
            }

            function displayWorksheet(category) {
                // 更新按钮的激活状态
                document.querySelectorAll('#worksheet-tabs button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.category === category);
                });
                
                // 填充表格
                resultsBody.innerHTML = '';
                const papers = currentResults[category] || [];
                papers.forEach(paper => {
                    const row = resultsBody.insertRow();
                    row.innerHTML = `
                        <td>${paper.venue_name || ''}</td>
                        <td>${paper.year || ''}</td>
                        <td>${paper.title || ''}</td>
                        <td>${paper.matched_keywords || ''}</td>
                        <td>${paper.author || ''}</td>
                        <td>${paper.citations || 0}</td>
                        <td><a href="${paper.url}" target="_blank">链接</a></td>
                    `;
                });
            }

            // 处理表单提交
            searchForm.addEventListener('submit', function(event) {
                event.preventDefault();

                stopFlashing(); // 开始新搜索前，停止任何可能正在进行的闪烁
                
                // 如果有正在进行的搜索，则中止它
                if (currentSearchController) {
                    currentSearchController.abort();
                }
                currentSearchController = new AbortController();
                const signal = currentSearchController.signal;

                searchStartTime = performance.now();
                loadingDiv.style.display = 'block';
                resultsTable.style.display = 'none';
                errorMessageDiv.textContent = '';
                searchSummarySpan.textContent = '';
                resultsBody.innerHTML = '';
                worksheetTabs.innerHTML = ''; // 清空旧的工作表标签
                exportBtn.style.display = 'none'; // 隐藏导出按钮
                currentResults = {}; // 清空旧的结果

                searchFieldset.disabled = true;
                submitBtn.style.display = 'none';
                cancelBtn.style.display = 'block';

                const selectedVenues = Array.from(venuesSelect.selectedOptions).map(opt => opt.value);
                const data = {
                    source: 'semantic_scholar', // 源现在是固定的
                    query_keywords: document.getElementById('query-keywords').value,
                    abstract_keywords: document.getElementById('abstract-keywords').value,
                    year: document.getElementById('year').value,
                    venues: selectedVenues,
                    limit: document.getElementById('limit').value,
                    title_exclude_keywords: document.getElementById('title_exclude_keywords').value
                };

                if (selectedVenues.includes('arXiv')) {
                    data.min_arxiv_citations = document.getElementById('min-arxiv-citations').value;
                }

                console.log("DEBUG: 即将发送到后端的数据:", JSON.stringify(data));

                fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    signal: signal // 传递中止信号
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || '搜索失败') });
                    }
                    return response.json();
                })
                .then(groupedData => {
                    currentResults = groupedData;
                    const categories = Object.keys(groupedData);
                    const totalPapers = categories.reduce((sum, cat) => sum + groupedData[cat].length, 0);

                    if (totalPapers === 0) {
                        errorMessageDiv.textContent = '没有找到符合条件的论文。';
                        return;
                    }

                    resultsTable.style.display = 'table';
                    exportBtn.style.display = 'block'; // 显示导出按钮
                    
                    // 创建工作表标签
                    categories.forEach(category => {
                        const button = document.createElement('button');
                        button.textContent = `${category} (${groupedData[category].length})`;
                        button.dataset.category = category;
                        button.addEventListener('click', () => displayWorksheet(category));
                        worksheetTabs.appendChild(button);
                    });
                    
                    // 默认显示第一个工作表
                    if (categories.length > 0) {
                        displayWorksheet(categories[0]);
                    }
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        console.log('搜索已被用户取消。');
                        errorMessageDiv.textContent = '搜索已取消。';
                    } else {
                        errorMessageDiv.textContent = `发生错误: ${error.message}`;
                        console.error('搜索时出错:', error);
                    }
                })
                .finally(() => {
                    // 只有当这个fetch是我们最后发出的那个时，才重置UI
                    if (signal === (currentSearchController && currentSearchController.signal)) {
                        
                        if (!signal.aborted) {
                            const endTime = performance.now();
                            const durationInSeconds = ((endTime - searchStartTime) / 1000).toFixed(2);
                            const paperCount = Object.values(currentResults).reduce((sum, papers) => sum + papers.length, 0);

                            if (paperCount > 0) {
                                searchSummarySpan.textContent = `(共找到 ${paperCount} 篇, 耗时 ${durationInSeconds} 秒)`;
                                // 如果页面在后台，则开始闪烁标题以提醒用户
                                if (document.hidden) {
                                    startFlashing(`搜索完成! 共${paperCount}篇论文`);
                                }
                            } else if (!errorMessageDiv.textContent.includes('错误')) {
                                searchSummarySpan.textContent = `(耗时 ${durationInSeconds} 秒)`;
                            }
                        }
                        
                        resetFormUI();
                    }
                });
            });

            // 处理取消按钮点击
            cancelBtn.addEventListener('click', function() {
                if (currentSearchController) {
                    currentSearchController.abort();
                }
                searchSummarySpan.textContent = '';
                resetFormUI();
            });

            // 处理导出按钮点击
            exportBtn.addEventListener('click', function() {
                if (Object.keys(currentResults).length === 0) {
                    alert('没有可导出的数据。');
                    return;
                }

                const originalBtnText = exportBtn.textContent;
                exportBtn.textContent = '正在生成...';
                exportBtn.disabled = true;

                fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentResults)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('导出失败。');
                    }
                    const header = response.headers.get('Content-Disposition');
                    const parts = header.split(';');
                    let filename = 'report.xlsx';
                    parts.forEach(part => {
                        if (part.trim().startsWith('filename=')) {
                            filename = part.split('=')[1].trim().replace(/"/g, '');
                        }
                    });
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('导出时出错:', error);
                    alert(error.message);
                })
                .finally(() => {
                    exportBtn.textContent = originalBtnText;
                    exportBtn.disabled = false;
                });
            });

            // --- arXiv 时间窗口搜索面板逻辑 ---
            let arxivCurrentSearchController = null;
            let arxivCurrentResults = {};

            const arxivSearchForm = document.getElementById('arxiv-search-form');
            const arxivFieldset = document.getElementById('arxiv-search-fieldset');
            const arxivSubmitBtn = document.getElementById('arxiv-submit-btn');
            const arxivCancelBtn = document.getElementById('arxiv-cancel-btn');
            const arxivLoadingDiv = document.getElementById('arxiv-loading');
            const arxivResultsTable = document.getElementById('arxiv-results-table');
            const arxivResultsBody = arxivResultsTable.querySelector('tbody');
            const arxivErrorMessageDiv = document.getElementById('arxiv-error-message');
            const arxivSearchSummarySpan = document.getElementById('arxiv-search-summary');
            const arxivDirectionsContainer = document.getElementById('arxiv-directions-container');
            const addDirectionBtn = document.getElementById('add-direction-btn');
            const arxivWorksheetTabs = document.getElementById('arxiv-worksheet-tabs');
            const arxivExportBtn = document.getElementById('arxiv-export-btn');

            let directionCounter = 0;

            function addArxivDirection(isFirst = false) {
                directionCounter++;
                const directionId = directionCounter;

                const group = document.createElement('div');
                group.className = 'direction-group';
                group.dataset.id = directionId;
                
                group.innerHTML = `
                    <h4>搜索方向 #${directionId}</h4>
                    <div>
                        <label for="arxiv-query-keywords-${directionId}">查询关键词<br><small>(每行一组, 组内逗号隔开)</small></label>
                        <textarea id="arxiv-query-keywords-${directionId}" class="arxiv-query-keywords" placeholder="例如：&#10;LLM, Quantization" required></textarea>
                    </div>
                    <div style="margin-top:10px;">
                        <label for="arxiv-abstract-keywords-${directionId}">摘要必须包含的关键词<br><small>(每行一组, 逗号隔开)</small></label>
                        <textarea id="arxiv-abstract-keywords-${directionId}" class="arxiv-abstract-keywords" placeholder="例如：&#10;Quantization"></textarea>
                    </div>
                    <div style="margin-top:10px;">
                        <label for="arxiv-subjects-${directionId}">学科分类 (英文, 逗号分隔)</label>
                        <input type="text" id="arxiv-subjects-${directionId}" class="arxiv-subjects" placeholder="例如: cs.LG, cs.CV">
                    </div>
                    ${!isFirst ? '<button type="button" class="remove-direction-btn">&times;</button>' : ''}
                `;
                
                arxivDirectionsContainer.appendChild(group);

                if (!isFirst) {
                    group.querySelector('.remove-direction-btn').addEventListener('click', () => {
                        group.remove();
                    });
                }
            }
            
            addDirectionBtn.addEventListener('click', () => addArxivDirection(false));

            function displayArxivWorksheet(directionKey) {
                document.querySelectorAll('#arxiv-worksheet-tabs button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.direction === directionKey);
                });

                arxivResultsBody.innerHTML = '';
                const papers = arxivCurrentResults[directionKey] || [];
                papers.forEach(paper => {
                    const row = arxivResultsBody.insertRow();
                    row.innerHTML = `
                        <td>${paper.updated || ''}</td>
                        <td>${paper.published || ''}</td>
                        <td>${paper.title || ''}</td>
                        <td>${paper.matched_keywords || ''}</td>
                        <td>${paper.author || ''}</td>
                        <td><a href="${paper.url}" target="_blank">链接</a></td>
                    `;
                });
            }

            arxivSearchForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                if (arxivCurrentSearchController) {
                    arxivCurrentSearchController.abort();
                }
                arxivCurrentSearchController = new AbortController();
                const signal = arxivCurrentSearchController.signal;

                arxivLoadingDiv.style.display = 'block';
                arxivResultsTable.style.display = 'none';
                arxivErrorMessageDiv.textContent = '';
                arxivSearchSummarySpan.textContent = '';
                arxivResultsBody.innerHTML = '';
                arxivWorksheetTabs.innerHTML = '';
                arxivExportBtn.style.display = 'none';
                arxivCurrentResults = {};

                arxivFieldset.disabled = true;
                arxivSubmitBtn.style.display = 'none';
                arxivCancelBtn.style.display = 'block';

                const directions = [];
                document.querySelectorAll('.direction-group').forEach(group => {
                    const queryKeywords = group.querySelector('.arxiv-query-keywords').value;
                    if (queryKeywords.trim() !== "") { // 只有在查询关键词不为空时才添加
                         directions.push({
                            query_keywords: queryKeywords,
                            abstract_keywords: group.querySelector('.arxiv-abstract-keywords').value,
                            subjects: group.querySelector('.arxiv-subjects').value,
                        });
                    }
                });

                if (directions.length === 0) {
                    arxivErrorMessageDiv.textContent = '请至少输入一组有效的查询关键词。';
                    resetArxivFormUI();
                    return;
                }

                const data = {
                    directions: directions,
                    days: document.getElementById('arxiv-days').value,
                    limit: document.getElementById('arxiv-limit').value,
                    min_authors: document.getElementById('arxiv-min-authors').value,
                };

                fetch('/api/arxiv_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    signal: signal
                })
                .then(response => {
                     if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || '搜索失败') });
                    }
                    return response.json();
                })
                .then(groupedData => {
                    arxivCurrentResults = groupedData;
                    const directionKeys = Object.keys(groupedData);
                    const totalPapers = directionKeys.reduce((sum, key) => sum + groupedData[key].length, 0);
                    
                    if (totalPapers === 0) {
                        arxivSearchSummarySpan.textContent = '没有找到符合条件的论文。';
                        return;
                    }

                    arxivResultsTable.style.display = 'table';
                    arxivExportBtn.style.display = 'block';
                    arxivSearchSummarySpan.textContent = `共找到 ${totalPapers} 篇论文。`;

                    directionKeys.forEach(key => {
                        const button = document.createElement('button');
                        button.textContent = `${key} (${groupedData[key].length})`;
                        button.dataset.direction = key;
                        button.addEventListener('click', () => displayArxivWorksheet(key));
                        arxivWorksheetTabs.appendChild(button);
                    });

                    if (directionKeys.length > 0) {
                        displayArxivWorksheet(directionKeys[0]);
                    }
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        arxivErrorMessageDiv.textContent = '搜索已取消。';
                    } else {
                        arxivErrorMessageDiv.textContent = `发生错误: ${error.message}`;
                    }
                })
                .finally(() => {
                    if (signal === (arxivCurrentSearchController && arxivCurrentSearchController.signal)) {
                        resetArxivFormUI();
                    }
                });
            });

            arxivCancelBtn.addEventListener('click', function() {
                if (arxivCurrentSearchController) {
                    arxivCurrentSearchController.abort();
                }
                resetArxivFormUI();
            });

            function resetArxivFormUI() {
                arxivLoadingDiv.style.display = 'none';
                arxivFieldset.disabled = false;
                arxivSubmitBtn.style.display = 'block';
                arxivCancelBtn.style.display = 'none';
                arxivCurrentSearchController = null;
            }

            arxivExportBtn.addEventListener('click', function() {
                if (Object.keys(arxivCurrentResults).length === 0) {
                    alert('没有可导出的数据。');
                    return;
                }

                const originalBtnText = arxivExportBtn.textContent;
                arxivExportBtn.textContent = '正在生成...';
                arxivExportBtn.disabled = true;

                fetch('/api/arxiv_export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(arxivCurrentResults)
                })
                .then(response => {
                    if (!response.ok) {
                         return response.json().then(err => { throw new Error(err.error || '导出失败') });
                    }
                    const header = response.headers.get('Content-Disposition');
                    const filename = header ? header.split('filename=')[1].replace(/"/g, '') : 'arxiv-report.xlsx';
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    alert(`导出失败: ${error.message}`);
                })
                .finally(() => {
                    arxivExportBtn.textContent = originalBtnText;
                    arxivExportBtn.disabled = false;
                });
            });

            // 初始化：添加第一个搜索方向
            addArxivDirection(true);
        });
    </script>
</body>
</html> 