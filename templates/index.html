<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学术论文搜索器</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1200px; margin: 20px auto; padding: 0 20px; background-color: #f8f9fa; }
        h1, h2 { color: #0056b3; }
        .container { display: flex; gap: 30px; }
        .form-section { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 40%; }
        /* 新增样式，用于在禁用时让表单变灰且不可点击 */
        fieldset:disabled { opacity: 0.5; pointer-events: none; }
        .results-section { width: 60%; }
        form { display: flex; flex-direction: column; gap: 15px; }
        label { font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #results-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        #results-table th, #results-table td { border: 1px solid #ddd; padding: 10px; text-align: left; word-wrap: break-word; }
        #results-table th { background-color: #e9ecef; }
        #results-table tr:nth-child(even) { background-color: #f8f9fa; }
        #loading { display: none; text-align: center; padding: 20px; font-size: 18px; color: #0056b3; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>学术论文搜索器</h1>
    <div class="container">
        <div class="form-section">
            <h2>搜索条件</h2>
            <form id="search-form">
                <fieldset id="search-fieldset">
                    <div>
                        <label>搜索来源</label>
                        <div>
                            <input type="radio" id="source-ss" name="source" value="semantic_scholar" checked>
                            <label for="source-ss">Semantic Scholar</label>
                            <!-- 暂时隐藏 arXiv 选项 -->
                            <div style="display: none;">
                                <input type="radio" id="source-arxiv" name="source" value="arxiv">
                                <label for="source-arxiv">arXiv</label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="query-keywords">查询关键词 (每行一组, 组内用空格隔开)</label>
                        <textarea id="query-keywords" name="query_keywords" placeholder="例如：&#10;LLM Quantization&#10;Large Language Model Quantization" required></textarea>
                    </div>
                    
                    <div>
                        <label for="abstract-keywords">摘要必须包含的关键词 (每行一组)</label>
                        <textarea id="abstract-keywords" name="abstract_keywords" placeholder="例如：&#10;LLM&#10;Quantization"></textarea>
                    </div>

                    <div>
                        <label for="year">最低年份</label>
                        <input type="number" id="year" name="year" placeholder="例如: 2023" value="2023">
                    </div>

                    <div id="venues-container">
                        <label for="venues">会议/期刊 (可多选)</label>
                        <select id="venues" name="venues" multiple size="8" style="width: 100%;"></select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label for="limit">最大篇数</label>
                            <input type="number" id="limit" name="limit" value="100">
                        </div>
                        <div>
                            <label for="sort_by">排序方式</label>
                            <select id="sort_by" name="sort_by" style="width: 100%; padding: 10px;">
                                <option value="relevance" selected>相关度</option>
                                <option value="citationCount">引用数</option>
                                <option value="year">年份</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="title_exclude_keywords">排除标题包含的词 (每行一个)</label>
                        <textarea id="title_exclude_keywords" name="title_exclude_keywords" placeholder="例如：&#10;review&#10;survey"></textarea>
                    </div>

                    <div>
                        <label for="fields_of_study">研究领域 (英文, 逗号分隔)</label>
                        <input type="text" id="fields_of_study" name="fields_of_study" placeholder="例如: Computer Science, Mathematics">
                    </div>

                </fieldset>
                
                <button type="submit" id="submit-btn">搜索</button>
                <button type="button" id="cancel-btn" style="display: none; background-color: #6c757d;">取消</button>
            </form>
        </div>
        <div class="results-section">
            <h2>搜索结果 <span id="search-summary" style="font-weight: normal; font-size: 0.8em; color: #555;"></span></h2>
            <div id="loading">正在搜索中，请稍候...</div>
            <div id="error-message" class="error"></div>
            <table id="results-table" style="display:none;">
                <thead>
                    <tr>
                        <th style="width: 30%;">标题</th>
                        <th style="width: 20%;">作者</th>
                        <th style="width: 8%;">年份</th>
                        <th style="width: 8%;">引用</th>
                        <th style="width: 17%;">会议/期刊</th>
                        <th style="width: 12%;">匹配关键词</th>
                        <th style="width: 5%;">链接</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentSearchController = null; // 用于管理中止信号
            let searchStartTime;

            const venuesSelect = document.getElementById('venues');
            const searchForm = document.getElementById('search-form');
            const searchFieldset = document.getElementById('search-fieldset'); 
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const loadingDiv = document.getElementById('loading');
            const resultsTable = document.getElementById('results-table');
            const resultsBody = resultsTable.querySelector('tbody');
            const errorMessageDiv = document.getElementById('error-message');
            const searchSummarySpan = document.getElementById('search-summary');

            fetch('/api/venues')
                .then(response => response.json())
                .then(data => {
                    venuesSelect.innerHTML = '';
                    for (const key in data) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = key;
                        venuesSelect.appendChild(option);
                    }
                })
                .catch(error => console.error('加载会议列表失败:', error));

            function resetFormUI() {
                loadingDiv.style.display = 'none';
                searchFieldset.disabled = false;
                submitBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                currentSearchController = null;
            }

            // 处理表单提交
            searchForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // 如果有正在进行的搜索，则中止它
                if (currentSearchController) {
                    currentSearchController.abort();
                }
                currentSearchController = new AbortController();
                const signal = currentSearchController.signal;

                searchStartTime = performance.now();
                loadingDiv.style.display = 'block';
                resultsTable.style.display = 'none';
                errorMessageDiv.textContent = '';
                searchSummarySpan.textContent = '';
                resultsBody.innerHTML = '';

                searchFieldset.disabled = true;
                submitBtn.style.display = 'none';
                cancelBtn.style.display = 'block';

                const data = {
                    source: document.querySelector('input[name="source"]:checked').value,
                    query_keywords: document.getElementById('query-keywords').value,
                    abstract_keywords: document.getElementById('abstract-keywords').value,
                    year: document.getElementById('year').value,
                    venues: Array.from(venuesSelect.selectedOptions).map(opt => opt.value),
                    limit: document.getElementById('limit').value,
                    sort_by: document.getElementById('sort_by').value,
                    title_exclude_keywords: document.getElementById('title_exclude_keywords').value,
                    fields_of_study: document.getElementById('fields_of_study').value
                };

                console.log("DEBUG: 即将发送到后端的数据:", JSON.stringify(data));

                fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    signal: signal // 传递中止信号
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || '搜索失败') });
                    }
                    return response.json();
                })
                .then(papers => {
                    if (papers.length === 0) {
                        errorMessageDiv.textContent = '没有找到符合条件的论文。';
                        return;
                    }
                    resultsTable.style.display = 'table';
                    papers.forEach(paper => {
                        const row = resultsBody.insertRow();
                        row.innerHTML = `
                            <td>${paper.title || ''}</td>
                            <td>${paper.author || ''}</td>
                            <td>${paper.year || ''}</td>
                            <td>${paper.citations || 0}</td>
                            <td>${paper.venue_name || ''}</td>
                            <td>${paper.matched_keywords || ''}</td>
                            <td><a href="${paper.url}" target="_blank">链接</a></td>
                        `;
                    });
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        console.log('搜索已被用户取消。');
                        errorMessageDiv.textContent = '搜索已取消。';
                    } else {
                        errorMessageDiv.textContent = `发生错误: ${error.message}`;
                        console.error('搜索时出错:', error);
                    }
                })
                .finally(() => {
                    // 只有当这个fetch是我们最后发出的那个时，才重置UI
                    if (signal === (currentSearchController && currentSearchController.signal)) {
                        
                        if (!signal.aborted) {
                            const endTime = performance.now();
                            const durationInSeconds = ((endTime - searchStartTime) / 1000).toFixed(2);
                            const paperCount = resultsBody.rows.length;

                            if (paperCount > 0) {
                                searchSummarySpan.textContent = `(找到 ${paperCount} 篇, 耗时 ${durationInSeconds} 秒)`;
                            } else if (!errorMessageDiv.textContent.includes('错误')) {
                                searchSummarySpan.textContent = `(耗时 ${durationInSeconds} 秒)`;
                            }
                        }
                        
                        resetFormUI();
                    }
                });
            });

            // 处理取消按钮点击
            cancelBtn.addEventListener('click', function() {
                if (currentSearchController) {
                    currentSearchController.abort();
                }
                searchSummarySpan.textContent = '';
                resetFormUI();
            });
        });
    </script>
</body>
</html> 