<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang="title">Academic Paper Search Tool</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1600px; margin: 20px auto; padding: 0 20px; background-color: #f8f9fa; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        h1, h2 { color: #0056b3; }
        .container { display: flex; gap: 30px; }
        .form-section { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 24%; flex-shrink: 0; }
        fieldset:disabled { opacity: 0.5; pointer-events: none; }
        .results-section { width: 76%; }
        form { display: flex; flex-direction: column; gap: 15px; }
        label { font-weight: bold; color: #555; }
        label > small {
            display: block;
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
            margin-top: -3px;
        }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; box-sizing: border-box; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; opacity: 0.65; cursor: not-allowed; }
        #results-table, #arxiv-results-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        #results-table th, #results-table td,
        #arxiv-results-table th, #arxiv-results-table td { border: 1px solid #ddd; padding: 10px; text-align: left; word-wrap: break-word; }
        #results-table th, #arxiv-results-table th { background-color: #e9ecef; }
        #results-table tr:nth-child(even),
        #arxiv-results-table tr:nth-child(even) { background-color: #f8f9fa; }
        #loading, #arxiv-loading { display: none; text-align: center; padding: 20px; font-size: 18px; color: #0056b3; }
        .error { color: #dc3545; }
        #worksheet-tabs button,
        #arxiv-worksheet-tabs button {
            background-color: #e9ecef; 
            border: 1px solid #ccc; 
            padding: 10px 15px; 
            cursor: pointer; 
            margin-right: 8px; 
            margin-bottom: 8px;
            border-radius: 4px 4px 0 0;
            font-size: 15px;
        }
        #worksheet-tabs button.active,
        #arxiv-worksheet-tabs button.active { 
            background-color: #007bff; 
            color: white; 
            border-color: #007bff; 
        }
        .tab-button { font-size: 18px; padding: 10px 15px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background: none; color: #555; }
        .tab-button.active { border-color: #ccc; border-bottom: 1px solid white; background-color: white; border-radius: 4px 4px 0 0; position: relative; top: 1px; color: #0056b3; font-weight: bold; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .direction-group { border: 1px solid #e0e0e0; padding: 15px; border-radius: 5px; margin-bottom: 15px; position: relative; }
        .direction-group h4 { margin-top: 0; color: #333; }
        .remove-direction-btn { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: #ff4d4d; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            font-size: 18px;
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0;
            box-sizing: border-box;
        }
        #add-direction-btn { background-color: #28a745; margin-top: 10px; }
        .config-btn { background-color: #6c757d; color: white; padding: 5px 10px; font-size: 12px; margin-left: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .config-btn:hover { background-color: #5a6268; }
        #export-btn, #arxiv-export-btn {
            text-align: center;
        }
        #lang-switcher { margin: 10px; font-size: 14px; padding: 5px 10px; cursor: pointer; }
        
        /* 增大"批量搜索"复选框的样式 */
        #bulk-search {
            transform: scale(1.4);
            margin-right: 8px;
        }
        /* 用于将复选框和其标签/描述对齐的容器 */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        /* 新增：用于确保按钮组水平排列的样式 */
        .results-button-group {
            display: flex;
            gap: 10px; /* 控制按钮之间的间距 */
            flex-shrink: 0; /* 防止按钮组在空间不足时被压缩 */
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="border-bottom: 1px solid #ccc; margin-bottom: -1px; flex-grow: 1;">
            <button class="tab-button active" data-tab="semantic-panel" data-lang="semantic_scholar_tab">Semantic Scholar Search</button>
            <button class="tab-button" data-tab="arxiv-panel" data-lang="arxiv_tab">arXiv Time-Window Search</button>
        </div>
        <button id="lang-switcher">切换语言 (Switch Language)</button>
    </div>

    <div id="semantic-panel" class="tab-panel active">
        <div class="container">
            <div class="form-section">
                <h2 data-lang="search_conditions">Search Conditions</h2>
                <form id="search-form">
                    <fieldset id="search-fieldset">
                        <div>
                            <label for="query-keywords" data-lang="query_keywords_label" data-lang-desc="query_keywords_desc"></label>
                            <textarea id="query-keywords" name="query_keywords" data-lang-placeholder="query_keywords_placeholder"></textarea>
                        </div>
                        
                        <div>
                            <label for="abstract-keywords" data-lang="abstract_keywords_label" data-lang-desc="abstract_keywords_desc"></label>
                            <textarea id="abstract-keywords" name="abstract_keywords" data-lang-placeholder="abstract_keywords_placeholder"></textarea>
                        </div>

                        <div>
                            <label for="year" data-lang="min_year_label">Minimum Year</label>
                            <input type="number" id="year" name="year" data-lang-placeholder="min_year_placeholder" value="2023">
                        </div>

                        <div class="checkbox-container">
                            <input type="checkbox" id="bulk-search" name="bulk_search" checked>
                            <label for="bulk-search" data-lang="bulk_search_label" data-lang-desc="bulk_search_desc"></label>
                        </div>

                        <div id="venues-container">
                            <label for="venues" data-lang="venues_label">Conferences/Journals (Multi-select)</label>
                            <select id="venues" name="venues" multiple size="8" style="width: 100%;"></select>
                        </div>
                        
                        <div id="arxiv-citations-container" style="display: none;">
                            <label for="min-arxiv-citations" data-lang="min_arxiv_citations_label">arXiv Minimum Citations (Default 15)</label>
                            <small data-lang="min_arxiv_citations_desc">(Minimum number of citations for arXiv papers)</small>
                            <input type="number" id="min-arxiv-citations" name="min_arxiv_citations" data-lang-placeholder="min_arxiv_citations_placeholder">
                        </div>

                        <div>
                            <label for="limit" data-lang="limit_label">Max Papers</label>
                            <input type="number" id="limit" name="limit" value="100">
                        </div>

                        <div>
                            <label for="title_exclude_keywords" data-lang="title_exclude_label" data-lang-desc="title_exclude_desc"></label>
                            <textarea id="title_exclude_keywords" name="title_exclude_keywords" data-lang-placeholder="title_exclude_placeholder"></textarea>
                        </div>
                    </fieldset>
                    
                    <button type="submit" id="submit-btn" data-lang="search_button">Search</button>
                    <button type="button" id="cancel-btn" style="display: none;" data-lang="cancel_button">Cancel</button>
                </form>
            </div>
            <div class="results-section">
                <h2><span data-lang="search_results">Search Results</span> <span id="search-summary" style="font-weight: normal; font-size: 0.8em; color: #555;"></span></h2>
                <div id="results-controls" style="display: none; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <div id="worksheet-tabs"></div>
                    <div class="results-button-group">
                        <button id="export-btn" data-lang="export_button">Export to Excel</button>
                        <button id="download-btn" data-lang="download_button">Download Papers</button>
                        <button id="cancel-download-btn" style="display: none; background-color: #6c757d;" data-lang="cancel_button">Cancel</button>
                    </div>
                </div>
                <div id="download-status" class="mb-2"></div>
                <div id="loading" data-lang="loading_message">Searching, please wait...</div>
                <div id="error-message" class="error"></div>
                <table id="results-table" style="display:none;">
                    <thead>
                        <tr>
                            <th style="width: 9%;" data-lang="table_header_venue">Conference/Journal</th>
                            <th style="width: 5%;" data-lang="table_header_year">Year</th>
                            <th style="width: 28%;" data-lang="table_header_title">Title</th>
                            <th style="width: 12%;" data-lang="table_header_matched_keywords">Matched Keywords</th>
                            <th style="width: 31%;" data-lang="table_header_authors">Authors</th>
                            <th style="width: 8%;" data-lang="table_header_citations">Citations</th>
                            <th style="width: 7%;" data-lang="table_header_link">Link</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="arxiv-panel" class="tab-panel">
        <div class="container">
            <div class="form-section">
                <h2 data-lang="search_conditions">Search Conditions</h2>
                <form id="arxiv-search-form">
                    <fieldset id="arxiv-search-fieldset">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 data-lang="common_settings_header">Common Settings</h4>
                            <div>
                                <button type="button" id="import-default-arxiv-config-btn" class="config-btn" data-lang="import_default_config_button">Import Default Config</button>
                                <button type="button" id="import-arxiv-config-btn" class="config-btn" data-lang="import_config_button">Import Config</button>
                                <button type="button" id="save-arxiv-config-btn" class="config-btn" data-lang="save_config_button">Save Config</button>
                                <input type="file" id="arxiv-config-input" style="display: none;" accept=".json">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label for="arxiv-days" data-lang="days_label">Search Days</label>
                                <input type="number" id="arxiv-days" name="days" value="7">
                            </div>
                            <div>
                                <label for="arxiv-limit" data-lang="limit_label">Max Papers</label>
                                <input type="number" id="arxiv-limit" name="limit" value="100">
                            </div>
                            <div>
                                <label for="arxiv-min-authors" data-lang="min_authors_label">Min Authors</label>
                                <input type="number" id="arxiv-min-authors" name="min_authors" value="2">
                            </div>
                        </div>

                        <hr style="margin: 20px 0;">
                        
                        <div id="arxiv-directions-container">
                            <!-- Dynamic search directions will be inserted here -->
                        </div>
                        <button type="button" id="add-direction-btn" data-lang="add_direction_button">+ Add Search Direction</button>
                        
                    </fieldset>
                    <button type="submit" id="arxiv-submit-btn" data-lang="search_button">Search</button>
                    <button type="button" id="arxiv-cancel-btn" style="display: none; background-color: #6c757d;" data-lang="cancel_button">Cancel</button>
                </form>
            </div>
            <div class="results-section">
                <h2><span data-lang="search_results">Search Results</span> <span id="arxiv-search-summary" style="font-weight: normal; font-size: 0.8em; color: #555;"></span></h2>
                 <div id="arxiv-results-controls" style="display: none; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <div id="arxiv-worksheet-tabs"></div>
                    <div class="results-button-group">
                        <button id="arxiv-export-btn" data-lang="export_button">Export to Excel</button>
                        <button id="arxiv-download-btn" data-lang="download_button">Download Papers</button>
                        <button id="cancel-arxiv-download-btn" style="display: none; background-color: #6c757d;" data-lang="cancel_button">Cancel</button>
                    </div>
                </div>
                <div id="arxiv-download-status" class="mb-2"></div>
                <div id="arxiv-loading" style="display: none;" data-lang="loading_message">Searching, please wait...</div>
                <div id="arxiv-error-message" class="error"></div>
                <table id="arxiv-results-table" style="display:none;">
                    <thead>
                        <tr>
                            <th style="width: 10%;" data-lang="table_header_updated">Updated</th>
                            <th style="width: 10%;" data-lang="table_header_published">Published</th>
                            <th style="width: 40%;" data-lang="table_header_title">Title</th>
                            <th style="width: 10%;" data-lang="table_header_matched_keywords">Matched Keywords</th>
                            <th style="width: 25%;" data-lang="table_header_authors">Authors</th>
                            <th style="width: 5%;" data-lang="table_header_link">Link</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- I18N (Internationalization) Logic ---
            let currentLanguage = 'en';
            let translations = {};

            const langSwitcher = document.getElementById('lang-switcher');

            // 确保 bulk search 复选框在页面加载时默认被选中
            document.getElementById('bulk-search').checked = true;

            async function fetchTranslations(lang) {
                try {
                    // 添加时间戳作为查询参数以防止浏览器缓存旧的语言文件
                    const response = await fetch(`/locales/${lang}.json?v=${new Date().getTime()}`);
                    if (!response.ok) {
                        throw new Error('Language file not found');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Could not load translations:', error);
                    return {}; // Return empty object on failure
                }
            }

            function applyTranslations() {
                // Process all elements with data-lang attribute
                document.querySelectorAll('[data-lang]').forEach(element => {
                    const key = element.getAttribute('data-lang');
                    if (!translations[key]) return;

                    // Handle labels specifically to manage descriptions
                    if (element.tagName === 'LABEL') {
                        let labelText = translations[key];
                        let descText = '';

                        // Check for an explicit description key
                        const descKey = element.getAttribute('data-lang-desc');
                        if (descKey && translations[descKey]) {
                            descText = translations[descKey];
                        } else {
                            // Check for an implicit description in parentheses
                            const match = labelText.match(/^(.*?)\s*(\(.*\))$/);
                            if (match) {
                                labelText = match[1];
                                descText = match[2];
                            }
                        }

                        if (descText) {
                            element.innerHTML = `${labelText}<small>${descText.trim()}</small>`;
                        } else {
                            element.textContent = labelText;
                        }

                    } else { // Handle all other elements
                        element.textContent = translations[key];
                    }
                });

                // Process placeholders separately
                document.querySelectorAll('[data-lang-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-lang-placeholder');
                    if (translations[key]) {
                        element.placeholder = translations[key].replace(/\\n/g, '\n');
                    }
                });
            }

            function setupDynamicWidths() {
                const t = key => translations[key] || '';
                
                const calculateMaxWidth = (button, textOptions) => {
                    if (!button) return 0;
                    let maxWidth = 0;

                    // Clone the button to get its styles without affecting the original
                    const clone = button.cloneNode(true);
                    
                    // Style it to be off-screen and invisible but still take up layout space
                    clone.style.position = 'absolute';
                    clone.style.left = '-9999px';
                    clone.style.visibility = 'hidden';
                    clone.style.display = 'inline-block';
                    clone.style.minWidth = 'auto'; // Reset min-width for accurate measurement

                    document.body.appendChild(clone);

                    textOptions.forEach(text => {
                        if (text) {
                            clone.textContent = text;
                            // 使用 getBoundingClientRect().width 来获取包含 padding 的最终渲染宽度
                            maxWidth = Math.max(maxWidth, clone.getBoundingClientRect().width);
                        }
                    });

                    document.body.removeChild(clone);

                    return Math.ceil(maxWidth); // 向上取整以避免小数像素问题
                };

                // --- Export Buttons ---
                const exportBtn = document.getElementById('export-btn');
                const arxivExportBtn = document.getElementById('arxiv-export-btn');
                const exportTexts = [t('export_button'), t('exporting_button')];
                const exportMaxWidth = calculateMaxWidth(exportBtn, exportTexts);
                
                if (exportBtn) exportBtn.style.minWidth = `${exportMaxWidth}px`;
                if (arxivExportBtn) arxivExportBtn.style.minWidth = `${exportMaxWidth}px`;

                // --- Download/Cancel Buttons ---
                const downloadBtn = document.getElementById('download-btn');
                const cancelBtn = document.getElementById('cancel-download-btn');
                const arxivDownloadBtn = document.getElementById('arxiv-download-btn');
                const arxivCancelBtn = document.getElementById('cancel-arxiv-download-btn');
                
                const downloadTexts = [t('download_button'), t('cancel_button')];
                // Use one of the download buttons as a reference for measurement
                const downloadMaxWidth = calculateMaxWidth(downloadBtn || arxivDownloadBtn, downloadTexts);

                const allDownloadBtns = [downloadBtn, cancelBtn, arxivDownloadBtn, arxivCancelBtn];
                allDownloadBtns.forEach(btn => {
                    if (btn) btn.style.minWidth = `${downloadMaxWidth}px`;
                });
            }

            async function setLanguage(lang) {
                if (lang === currentLanguage && Object.keys(translations).length > 0) return;
                
                translations = await fetchTranslations(lang);
                applyTranslations();
                setupDynamicWidths(); // Recalculate widths on language change
                currentLanguage = lang;
                document.documentElement.lang = lang; // Update the lang attribute of the <html> tag
                localStorage.setItem('preferredLanguage', lang);
            }

            langSwitcher.addEventListener('click', () => {
                const newLang = currentLanguage === 'en' ? 'zh' : 'en';
                setLanguage(newLang);
            });

            // --- Panel Switching Logic ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabPanels.forEach(panel => {
                        if (panel.id === button.dataset.tab) {
                            panel.classList.add('active');
                        } else {
                            panel.classList.remove('active');
                        }
                    });
                });
            });

            // --- Semantic Scholar Panel Logic ---
            let currentSearchController = null; 
            let searchStartTime;
            let currentResults = {}; 
            let originalTitle = document.title;
            let flashInterval = null;

            const venuesSelect = document.getElementById('venues');
            const searchForm = document.getElementById('search-form');
            const searchFieldset = document.getElementById('search-fieldset'); 
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const loadingDiv = document.getElementById('loading');
            const resultsTable = document.getElementById('results-table');
            const resultsBody = resultsTable.querySelector('tbody');
            const errorMessageDiv = document.getElementById('error-message');
            const searchSummarySpan = document.getElementById('search-summary');
            const worksheetTabs = document.getElementById('worksheet-tabs');
            const exportBtn = document.getElementById('export-btn');
            const downloadBtn = document.getElementById('download-btn');
            const resultsControls = document.getElementById('results-controls');
            const downloadStatus = document.getElementById('download-status');
            const cancelDownloadBtn = document.getElementById('cancel-download-btn');
            const venuesContainer = document.getElementById('venues-container');
            const arxivCitationsContainer = document.getElementById('arxiv-citations-container');

            venuesSelect.addEventListener('change', function() {
                const selectedOptions = Array.from(venuesSelect.selectedOptions).map(opt => opt.value);
                if (selectedOptions.includes('arXiv')) {
                    arxivCitationsContainer.style.display = 'block';
                } else {
                    arxivCitationsContainer.style.display = 'none';
                }
            });

            let mouseDownTime = 0;
            let wasSelectedOnMousedown = false;

            venuesSelect.addEventListener('mousedown', function(event) {
                if (event.target.tagName === 'OPTION') {
                    mouseDownTime = new Date().getTime();
                    // Capture the state at the very beginning of the interaction
                    wasSelectedOnMousedown = event.target.selected;
                }
            });

            venuesSelect.addEventListener('mouseup', function(event) {
                if (event.target.tagName === 'OPTION') {
                    const option = event.target;
                    const timeDiff = new Date().getTime() - mouseDownTime;

                    let isClick = false;
                    if (wasSelectedOnMousedown) {
                        // This was a DE-SELECTION attempt.
                        if (timeDiff < 150) {
                            isClick = true;
                        }
                    } else {
                        // This was a SELECTION attempt.
                        if (timeDiff < 150) {
                            isClick = true;
                        }
                    }

                    if (isClick) {
                        // This is a valid click, so we take full manual control.
                        event.preventDefault();

                        // Manually set the state based on what it was BEFORE the click.
                        // This avoids the race condition with the browser's default action.
                        option.selected = !wasSelectedOnMousedown;

                        // Notify other parts of the app that a change has occurred.
                        const changeEvent = new Event('change', { bubbles: true });
                        venuesSelect.dispatchEvent(changeEvent);
                    }
                    // If it's not a valid click (i.e., a drag), we do nothing and
                    // let the browser's default drag-selection behavior take over.
                }
            });

            window.addEventListener('focus', stopFlashing);

            fetch('/api/venues')
                .then(response => response.json())
                .then(data => {
                    venuesSelect.innerHTML = ''; 
                    data.forEach(group => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = group.category;
                        group.venues.forEach(venue => {
                            const option = document.createElement('option');
                            option.value = venue.key;
                            option.textContent = venue.name;
                            optgroup.appendChild(option);
                        });
                        venuesSelect.appendChild(optgroup);
                    });
                })
                .catch(error => console.error('Failed to load venue list:', error));

            function startFlashing(message) {
                if (flashInterval) return;
                let flashing = false;
                flashInterval = setInterval(() => {
                    document.title = flashing ? (translations['title'] || originalTitle) : message;
                    flashing = !flashing;
                }, 800);
            }

            function stopFlashing() {
                if (flashInterval) {
                    clearInterval(flashInterval);
                    flashInterval = null;
                    document.title = translations['title'] || originalTitle;
                }
            }

            function resetFormUI() {
                loadingDiv.style.display = 'none';
                searchFieldset.disabled = false;
                submitBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                currentSearchController = null;
            }

            function displayWorksheet(category) {
                document.querySelectorAll('#worksheet-tabs button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.category === category);
                });
                
                resultsBody.innerHTML = '';
                const papers = currentResults[category] || [];
                papers.forEach(paper => {
                    const row = resultsBody.insertRow();
                    row.innerHTML = `
                        <td>${paper.venue_name || ''}</td>
                        <td>${paper.year || ''}</td>
                        <td title="${paper.title}">${paper.title || ''}</td>
                        <td>${paper.matched_keywords || ''}</td>
                        <td>${paper.author || ''}</td>
                        <td>${paper.citations || 0}</td>
                        <td><a href="${paper.url}" target="_blank" title="${paper.title}">${translations['table_header_link'] || 'Link'}</a></td>
                    `;
                });
            }

            searchForm.addEventListener('submit', function(event) {
                event.preventDefault();

                // --- 新增：自定义验证逻辑 ---
                const queryKeywords = document.getElementById('query-keywords').value.trim();
                const isBulkSearch = document.getElementById('bulk-search').checked;

                if (!isBulkSearch && !queryKeywords) {
                    errorMessageDiv.textContent = translations['empty_query_message'] || 'Query keywords are required when not using bulk search.';
                    // 滚动到错误消息，使其可见
                    errorMessageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return; // 停止执行
                }


                stopFlashing();
                
                if (currentSearchController) {
                    currentSearchController.abort();
                }
                currentSearchController = new AbortController();
                const signal = currentSearchController.signal;

                searchStartTime = performance.now();
                loadingDiv.style.display = 'block';
                resultsTable.style.display = 'none';
                errorMessageDiv.textContent = '';
                searchSummarySpan.textContent = '';
                resultsBody.innerHTML = '';
                worksheetTabs.innerHTML = '';
                resultsControls.style.display = 'none';
                downloadStatus.innerHTML = '';
                currentResults = {};

                searchFieldset.disabled = true;
                submitBtn.style.display = 'none';
                cancelBtn.style.display = 'block';

                const selectedVenues = Array.from(venuesSelect.selectedOptions).map(opt => opt.value);
                const bulkSearch = document.getElementById('bulk-search').checked;

                const body = {
                    source: 'semantic_scholar',
                    query_keywords: document.getElementById('query-keywords').value,
                    abstract_keywords: document.getElementById('abstract-keywords').value,
                    year: document.getElementById('year').value,
                    venues: selectedVenues,
                    limit: document.getElementById('limit').value,
                    title_exclude_keywords: document.getElementById('title_exclude_keywords').value,
                    min_arxiv_citations: document.getElementById('min-arxiv-citations').value,
                    bulk_search: bulkSearch
                };

                if (selectedVenues.includes('arXiv')) {
                    body.min_arxiv_citations = document.getElementById('min-arxiv-citations').value;
                }

                fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    signal: signal
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Search failed') });
                    }
                    return response.json();
                })
                .then(groupedData => {
                    currentResults = groupedData;
                    const categories = Object.keys(groupedData);
                    const totalPapers = categories.reduce((sum, cat) => sum + groupedData[cat].length, 0);

                    if (totalPapers === 0) {
                        errorMessageDiv.textContent = translations['no_results_message'] || 'No matching papers found.';
                        return;
                    }

                    resultsTable.style.display = 'table';
                    resultsControls.style.display = 'flex';
                    
                    categories.forEach(category => {
                        const button = document.createElement('button');
                        button.textContent = `${category} (${groupedData[category].length})`;
                        button.dataset.category = category;
                        button.addEventListener('click', () => displayWorksheet(category));
                        worksheetTabs.appendChild(button);
                    });
                    
                    if (categories.length > 0) {
                        displayWorksheet(categories[0]);
                    }
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        errorMessageDiv.textContent = translations['search_cancelled_message'] || 'Search has been cancelled.';
                    } else {
                        errorMessageDiv.textContent = `${translations['error_prefix'] || 'An error occurred'}: ${error.message}`;
                    }
                })
                .finally(() => {
                    if (signal === (currentSearchController && currentSearchController.signal)) {
                        if (!signal.aborted) {
                            const endTime = performance.now();
                            const durationInSeconds = ((endTime - searchStartTime) / 1000).toFixed(2);
                            const paperCount = Object.values(currentResults).reduce((sum, papers) => sum + papers.length, 0);

                            if (paperCount > 0) {
                                const summaryTemplate = translations['search_summary_template'] || '(Found {count} papers in {seconds} seconds)';
                                const summaryText = summaryTemplate
                                    .replace('{count}', paperCount)
                                    .replace('{seconds}', durationInSeconds);
                                searchSummarySpan.textContent = summaryText;

                                if (document.hidden) {
                                    startFlashing(`${translations['flash_message_prefix'] || 'Search complete! Found'} ${paperCount} ${translations['flash_message_suffix'] || 'papers'}`);
                                }
                            } else if (!errorMessageDiv.textContent.includes(translations['error_prefix'] || 'error')) {
                                // 修正：即使没有结果，也显示耗时
                                const summaryTemplate = translations['search_summary_template'] || '(Found {count} papers in {seconds} seconds)';
                                const summaryText = summaryTemplate
                                    .replace('{count}', 0)
                                    .replace('{seconds}', durationInSeconds);
                                searchSummarySpan.textContent = summaryText;
                            }
                        }
                        resetFormUI();
                    }
                });
            });

            cancelBtn.addEventListener('click', function() {
                if (currentSearchController) {
                    currentSearchController.abort();
                }
                searchSummarySpan.textContent = '';
                resetFormUI();
            });

            let downloadController = null;

            function handleDownload(data, downloadBtn, cancelBtn, statusDiv, fieldset, searchBtn, isSemantic) {
                if (!data || Object.keys(data).length === 0) {
                    alert(translations['no_results_to_download'] || 'No results to download.');
                    return;
                }

                if (downloadController) return; // Prevent concurrent downloads

                downloadController = new AbortController();
                const signal = downloadController.signal;

                downloadBtn.style.display = 'none';
                cancelBtn.style.display = 'block';
                fieldset.disabled = true; // 禁用表单
                searchBtn.disabled = true; // 禁用搜索按钮
                statusDiv.className = 'mb-2'; // 重置样式

                let downloadStartTime = performance.now();
                let timerInterval = setInterval(() => {
                    const elapsedTime = ((performance.now() - downloadStartTime) / 1000).toFixed(1);
                    const template = translations['downloading_papers_template'] || 'Downloading... ({seconds}s)';
                    const timerText = template.replace('{seconds}', elapsedTime);
                    
                    if (isSemantic) {
                        const disclaimer = translations['download_disclaimer'] || '';
                        statusDiv.innerHTML = `${timerText} <small class="text-muted" style="margin-left: 10px;">${disclaimer}</small>`;
                    } else {
                        statusDiv.textContent = timerText;
                    }
                }, 200);

                fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data }),
                    signal: signal
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Download preparation failed') });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.status === 'success') {
                        const template = translations['download_summary_template'] || 'Successfully downloaded {successful}/{total} papers.';
                        const message = template.replace('{successful}', result.successful).replace('{total}', result.total);
                        statusDiv.textContent = message;
                        statusDiv.classList.add('text-success');

                        if (result.file_id) {
                            window.location.href = `/api/download_file/${result.file_id}`;
                        }
                    } else {
                        throw new Error(result.message || 'An unknown error occurred during download.');
                    }
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        statusDiv.textContent = translations['download_cancelled_message'] || 'Download cancelled.';
                        statusDiv.classList.add('text-warning');
                    } else {
                        statusDiv.textContent = `${translations['error_prefix'] || 'Error'}: ${error.message}`;
                        statusDiv.classList.add('text-danger');
                    }
                })
                .finally(() => {
                    clearInterval(timerInterval);
                    downloadBtn.style.display = 'block';
                    cancelBtn.style.display = 'none';
                    fieldset.disabled = false; // 重新启用表单
                    searchBtn.disabled = false; // 重新启用搜索按钮
                    downloadController = null;
                });
            }

            downloadBtn.addEventListener('click', function() {
                handleDownload(currentResults, downloadBtn, cancelDownloadBtn, downloadStatus, searchFieldset, submitBtn, true);
            });
            
            cancelDownloadBtn.addEventListener('click', function() {
                if (downloadController) {
                    downloadController.abort();
                }
            });

            exportBtn.addEventListener('click', function() {
                if (Object.keys(currentResults).length === 0) {
                    alert(translations['no_export_data_message'] || 'No data to export.');
                    return;
                }

                exportBtn.textContent = translations['exporting_button'] || 'Generating...';
                exportBtn.disabled = true;

                fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lang: currentLanguage, // 修复：将当前语言传递给后端
                        data: currentResults
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Export failed.');
                    const header = response.headers.get('Content-Disposition');
                    const parts = header.split(';');
                    let filename = 'report.xlsx';
                    parts.forEach(part => {
                        if (part.trim().startsWith('filename=')) {
                            filename = part.split('=')[1].trim().replace(/"/g, '');
                        }
                    });
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => alert(error.message))
                .finally(() => {
                    exportBtn.textContent = translations['export_button'] || 'Export to Excel';
                    exportBtn.disabled = false;
                });
            });

            // --- arXiv Time Window Search Panel Logic ---
            let arxivCurrentSearchController = null;
            let arxivCurrentResults = {};
            let arxivSearchStartTime;

            const arxivSearchForm = document.getElementById('arxiv-search-form');
            const arxivFieldset = document.getElementById('arxiv-search-fieldset');
            const arxivSubmitBtn = document.getElementById('arxiv-submit-btn');
            const arxivCancelBtn = document.getElementById('arxiv-cancel-btn');
            const arxivLoadingDiv = document.getElementById('arxiv-loading');
            const arxivResultsTable = document.getElementById('arxiv-results-table');
            const arxivResultsBody = arxivResultsTable.querySelector('tbody');
            const arxivErrorMessageDiv = document.getElementById('arxiv-error-message');
            const arxivSearchSummarySpan = document.getElementById('arxiv-search-summary');
            const arxivDirectionsContainer = document.getElementById('arxiv-directions-container');
            const addDirectionBtn = document.getElementById('add-direction-btn');
            const arxivWorksheetTabs = document.getElementById('arxiv-worksheet-tabs');
            const arxivExportBtn = document.getElementById('arxiv-export-btn');

            // --- 新增: arXiv 下载功能相关的元素 ---
            const arxivDownloadBtn = document.getElementById('arxiv-download-btn');
            const arxivDownloadStatus = document.getElementById('arxiv-download-status');
            const arxivResultsControls = document.getElementById('arxiv-results-controls');
            const cancelArxivDownloadBtn = document.getElementById('cancel-arxiv-download-btn');


            // --- 新增: arXiv 下载功能 ---
            arxivDownloadBtn.addEventListener('click', function() {
                handleDownload(arxivCurrentResults, arxivDownloadBtn, cancelArxivDownloadBtn, arxivDownloadStatus, arxivFieldset, arxivSubmitBtn, false);
            });

            cancelArxivDownloadBtn.addEventListener('click', function() {
                if (downloadController) {
                    downloadController.abort();
                }
            });

            let directionCounter = 0;

            function addArxivDirection(isFirst = false) {
                directionCounter++;
                const directionId = directionCounter;
                const group = document.createElement('div');
                group.className = 'direction-group';
                group.dataset.id = directionId;
                
                group.innerHTML = `
                    <div>
                        <label for="arxiv-direction-name-${directionId}" data-lang="direction_header">Search Direction</label>
                        <input type="text" id="arxiv-direction-name-${directionId}" class="arxiv-direction-name" data-lang-placeholder="direction_name_placeholder">
                    </div>
                    <div>
                        <label for="arxiv-query-keywords-${directionId}" data-lang="query_keywords_label" data-lang-desc="query_keywords_desc"></label>
                        <textarea id="arxiv-query-keywords-${directionId}" class="arxiv-query-keywords" data-lang-placeholder="query_keywords_placeholder" required></textarea>
                    </div>
                    <div style="margin-top:10px;">
                        <label for="arxiv-abstract-keywords-${directionId}" data-lang="abstract_keywords_label" data-lang-desc="abstract_keywords_desc"></label>
                        <textarea id="arxiv-abstract-keywords-${directionId}" class="arxiv-abstract-keywords" data-lang-placeholder="abstract_keywords_placeholder"></textarea>
                    </div>
                    <div style="margin-top:10px;">
                        <label for="arxiv-subjects-${directionId}" data-lang="subjects_label"></label>
                        <input type="text" id="arxiv-subjects-${directionId}" class="arxiv-subjects" data-lang-placeholder="subjects_placeholder">
                    </div>
                    ${!isFirst ? '<button type="button" class="remove-direction-btn">&times;</button>' : ''}
                `;
                
                arxivDirectionsContainer.appendChild(group);

                const defaultSubjects = 'cs.AI, cs.AR, cs.CL, cs.CV, "cs.LG, "cs.RO';
                group.querySelector('.arxiv-subjects').value = defaultSubjects;

                if (!isFirst) {
                    group.querySelector('.remove-direction-btn').addEventListener('click', () => group.remove());
                }
                applyTranslations(); // Apply to newly added elements
            }
            
            addDirectionBtn.addEventListener('click', () => addArxivDirection(false));

            const importDefaultArxivConfigBtn = document.getElementById('import-default-arxiv-config-btn');
            const importArxivConfigBtn = document.getElementById('import-arxiv-config-btn');
            const saveArxivConfigBtn = document.getElementById('save-arxiv-config-btn');
            const arxivConfigInput = document.getElementById('arxiv-config-input');

            importDefaultArxivConfigBtn.addEventListener('click', () => {
                fetch('configs/arxiv_window.json')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load default config');
                        return response.json();
                    })
                    .then(config => populateArxivForm(config))
                    .catch(error => alert(error.message));
            });

            importArxivConfigBtn.addEventListener('click', () => arxivConfigInput.click());

            arxivConfigInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        populateArxivForm(JSON.parse(e.target.result));
                    } catch (error) {
                        alert(`${translations['import_error_message'] || 'Error parsing JSON file'}: ${error.message}`);
                    }
                };
                reader.readAsText(file);
                event.target.value = null;
            });

            function populateArxivForm(config) {
                if (config.search_settings) {
                    document.getElementById('arxiv-days').value = config.search_settings.search_window_days || 7;
                    document.getElementById('arxiv-limit').value = config.search_settings.limit_per_topic || 100;
                    document.getElementById('arxiv-min-authors').value = config.search_settings.min_authors || 1;
                }

                if (config.search_topics && Array.isArray(config.search_topics)) {
                    arxivDirectionsContainer.innerHTML = '';
                    directionCounter = 0;
                    if (config.search_topics.length === 0) {
                        addArxivDirection(true);
                        return;
                    }
                    config.search_topics.forEach((topic, index) => {
                        addArxivDirection(index === 0);
                        const newGroup = arxivDirectionsContainer.lastChild;
                        if (newGroup) {
                            newGroup.querySelector('.arxiv-direction-name').value = topic.direction || '';
                            newGroup.querySelector('.arxiv-query-keywords').value = (topic.query_keywords || []).map(g => g.join(', ')).join('\n');
                            newGroup.querySelector('.arxiv-abstract-keywords').value = (topic.abstract_keywords || []).map(g => g.join(', ')).join('\n');
                            newGroup.querySelector('.arxiv-subjects').value = (topic.subjects || []).join(', ');
                        }
                    });
                }
            }

            saveArxivConfigBtn.addEventListener('click', () => {
                try {
                    const config = { search_topics: [], search_settings: {} };
                    config.search_settings.search_window_days = parseInt(document.getElementById('arxiv-days').value, 10);
                    config.search_settings.limit_per_topic = parseInt(document.getElementById('arxiv-limit').value, 10);
                    config.search_settings.min_authors = parseInt(document.getElementById('arxiv-min-authors').value, 10);

                    document.querySelectorAll('.direction-group').forEach((group, index) => {
                        const name = group.querySelector('.arxiv-direction-name').value.trim();
                        const queryKeywords = group.querySelector('.arxiv-query-keywords').value.split('\n').filter(l => l.trim()).map(l => l.split(',').map(kw => kw.trim()));
                        const abstractKeywords = group.querySelector('.arxiv-abstract-keywords').value.split('\n').filter(l => l.trim()).map(l => l.split(',').map(kw => kw.trim()));
                        const subjects = group.querySelector('.arxiv-subjects').value.split(',').map(s => s.trim()).filter(s => s);
                        config.search_topics.push({
                            direction: name || `${translations['direction_header'] || 'Direction'} ${index + 1}`,
                            query_keywords: queryKeywords,
                            abstract_keywords: abstractKeywords,
                            subjects: subjects
                        });
                    });

                    const configString = JSON.stringify(config, null, 4);
                    const blob = new Blob([configString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'arxiv_config.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    alert(`${translations['save_error_message'] || 'Failed to save config'}: ${error.message}`);
                }
            });

            function displayArxivWorksheet(directionKey) {
                document.querySelectorAll('#arxiv-worksheet-tabs button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.direction === directionKey);
                });
                arxivResultsBody.innerHTML = '';
                const papers = arxivCurrentResults[directionKey] || [];
                papers.forEach(paper => {
                    const row = arxivResultsBody.insertRow();
                    row.innerHTML = `
                        <td>${paper.updated || ''}</td>
                        <td>${paper.published || ''}</td>
                        <td title="${paper.title}">${paper.title || ''}</td>
                        <td>${paper.matched_keywords || ''}</td>
                        <td>${paper.author || ''}</td>
                        <td><a href="${paper.url}" target="_blank">${translations['table_header_link'] || 'Link'}</a></td>
                    `;
                });
            }

            arxivSearchForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (arxivCurrentSearchController) arxivCurrentSearchController.abort();
                arxivCurrentSearchController = new AbortController();
                const signal = arxivCurrentSearchController.signal;

                arxivSearchStartTime = performance.now();
                arxivLoadingDiv.style.display = 'block';
                arxivResultsTable.style.display = 'none';
                arxivErrorMessageDiv.textContent = '';
                arxivSearchSummarySpan.textContent = '';
                arxivResultsBody.innerHTML = '';
                arxivWorksheetTabs.innerHTML = '';
                arxivResultsControls.style.display = 'none'; // 隐藏控制区
                arxivDownloadStatus.innerHTML = ''; // 清空下载状态
                arxivCurrentResults = {};

                arxivFieldset.disabled = true;
                arxivSubmitBtn.style.display = 'none';
                arxivCancelBtn.style.display = 'block';

                const directions = [];
                document.querySelectorAll('.direction-group').forEach(group => {
                    const queryKeywords = group.querySelector('.arxiv-query-keywords').value;
                    if (queryKeywords.trim() !== "") {
                        const name = group.querySelector('.arxiv-direction-name').value.trim();
                        directions.push({
                            name: name || `${translations['direction_header'] || 'Direction'} ${directions.length + 1}`,
                            query_keywords: queryKeywords,
                            abstract_keywords: group.querySelector('.arxiv-abstract-keywords').value,
                            subjects: group.querySelector('.arxiv-subjects').value,
                        });
                    }
                });

                if (directions.length === 0) {
                    arxivErrorMessageDiv.textContent = translations['empty_arxiv_query_message'] || 'Please enter at least one valid set of query keywords.';
                    resetArxivFormUI();
                    return;
                }

                const data = {
                    directions: directions,
                    days: document.getElementById('arxiv-days').value,
                    limit: document.getElementById('arxiv-limit').value,
                    min_authors: document.getElementById('arxiv-min-authors').value,
                };

                fetch('/api/arxiv_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    signal: signal
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Search failed') });
                    }
                    return response.json();
                })
                .then(groupedData => {
                    arxivCurrentResults = groupedData;
                    const directionKeys = Object.keys(groupedData);
                    const totalPapers = directionKeys.reduce((sum, key) => sum + groupedData[key].length, 0);
                    if (totalPapers === 0) {
                        arxivErrorMessageDiv.textContent = translations['no_results_message'] || 'No matching papers found.';
                        return; // 直接返回，finally块会处理UI状态
                    }
                    arxivResultsTable.style.display = 'table';
                    arxivResultsControls.style.display = 'flex'; // 显示控制区，包括导出和下载按钮
                    directionKeys.forEach(key => {
                        const button = document.createElement('button');
                        button.textContent = `${key} (${groupedData[key].length})`;
                        button.dataset.direction = key;
                        button.addEventListener('click', () => displayArxivWorksheet(key));
                        arxivWorksheetTabs.appendChild(button);
                    });
                    if (directionKeys.length > 0) displayArxivWorksheet(directionKeys[0]);
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        arxivErrorMessageDiv.textContent = translations['search_cancelled_message'] || 'Search cancelled.';
                    } else {
                        arxivErrorMessageDiv.textContent = `${translations['error_prefix'] || 'An error occurred'}: ${error.message}`;
                    }
                })
                .finally(() => {
                    if (signal === (arxivCurrentSearchController && arxivCurrentSearchController.signal)) {
                        if (!signal.aborted) {
                            const endTime = performance.now();
                            const durationInSeconds = ((endTime - arxivSearchStartTime) / 1000).toFixed(2);
                            const paperCount = Object.values(arxivCurrentResults).reduce((sum, papers) => sum + papers.length, 0);
                            
                            const summaryTemplate = translations['search_summary_template'] || '(Found {count} papers in {seconds} seconds)';
                            const summaryText = summaryTemplate
                                .replace('{count}', paperCount)
                                .replace('{seconds}', durationInSeconds);

                            arxivSearchSummarySpan.textContent = summaryText; // 总是显示摘要，即使是0个结果

                        }
                        resetArxivFormUI();
                    }
                });
            });

            arxivCancelBtn.addEventListener('click', function() {
                if (arxivCurrentSearchController) arxivCurrentSearchController.abort();
                resetArxivFormUI();
            });

            function resetArxivFormUI() {
                arxivLoadingDiv.style.display = 'none';
                arxivFieldset.disabled = false;
                arxivSubmitBtn.style.display = 'block';
                arxivCancelBtn.style.display = 'none';
                arxivCurrentSearchController = null;
            }

            arxivExportBtn.addEventListener('click', function() {
                if (Object.keys(arxivCurrentResults).length === 0) {
                    alert(translations['no_export_data_message'] || 'No data to export.');
                    return;
                }
                arxivExportBtn.textContent = translations['exporting_button'] || 'Generating...';
                arxivExportBtn.disabled = true;

                fetch('/api/arxiv_export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lang: currentLanguage,
                        data: arxivCurrentResults
                    })
                })
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.error || 'Export failed') });
                    const header = response.headers.get('Content-Disposition');
                    const filename = header ? header.split('filename=')[1].replace(/"/g, '') : 'arxiv-report.xlsx';
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => alert(`Export failed: ${error.message}`))
                .finally(() => {
                    arxivExportBtn.textContent = translations['export_button'] || 'Export to Excel';
                    arxivExportBtn.disabled = false;
                });
            });

            // --- Initializer ---
            const preferredLanguage = localStorage.getItem('preferredLanguage') || (navigator.language.startsWith('zh') ? 'zh' : 'en');
            setLanguage(preferredLanguage).then(() => {
                addArxivDirection(true); // Add initial direction after language is set
                
                // Restore the button text after the initial language-based sizing
                exportBtn.textContent = translations['export_button'] || 'Export to Excel';
                arxivExportBtn.textContent = translations['export_button'] || 'Export to Excel';
            });
        });
    </script>
</body>
</html> 